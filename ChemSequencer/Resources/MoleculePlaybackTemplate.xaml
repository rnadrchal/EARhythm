<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:converters="clr-namespace:Egami.Sequencer.UI.Converters;assembly=Egami.Sequencer.UI"
                    xmlns:vm="clr-namespace:ChemSequencer.ViewModels">

    <!-- Converters -->
    <converters:DoubleToDiameterConverter x:Key="DoubleToDiameter" />
    <converters:BoolToStrokeConverter x:Key="BoolToStroke" />
    <converters:BoolToStrokeThicknessConverter x:Key="BoolToStrokeThickness" />
    <converters:CenterToTopLeftMultiConverter x:Key="CenterToTopLeft" />

    <!-- DataTemplate für das MoleculePlaybackViewModel -->
    <DataTemplate DataType="{x:Type vm:MoleculePlaybackViewModel}">
        <Grid>
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                <Canvas Background="Transparent">
                    <!-- Bonds zuerst -->
                    <ItemsControl ItemsSource="{Binding Bonds}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style TargetType="ContentPresenter">
                                <Setter Property="Canvas.Left" Value="0" />
                                <Setter Property="Canvas.Top" Value="0" />
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Line X1="{Binding StartX}" Y1="{Binding StartY}"
                                      X2="{Binding EndX}" Y2="{Binding EndY}"
                                      Stroke="{Binding Stroke}" StrokeThickness="{Binding Thickness}"
                                      StrokeStartLineCap="Round" StrokeEndLineCap="Round" SnapsToDevicePixels="True"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Atome oben drüber -->
                    <ItemsControl ItemsSource="{Binding Atoms}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <!-- Neuer ItemContainerStyle: berechnet Canvas.Left/Top = X - Radius, Y - Radius -->
                        <ItemsControl.ItemContainerStyle>
                            <Style TargetType="ContentPresenter">
                                <Setter Property="Canvas.Left">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource CenterToTopLeft}">
                                            <Binding Path="Content.X" RelativeSource="{RelativeSource Self}" />
                                            <Binding Path="Content.Radius" RelativeSource="{RelativeSource Self}" />
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="Canvas.Top">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource CenterToTopLeft}">
                                            <Binding Path="Content.Y" RelativeSource="{RelativeSource Self}" />
                                            <Binding Path="Content.Radius" RelativeSource="{RelativeSource Self}" />
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid SnapsToDevicePixels="True" UseLayoutRounding="True">
                                    <Ellipse Width="{Binding Radius, Converter={StaticResource DoubleToDiameter}}"
                                             Height="{Binding Radius, Converter={StaticResource DoubleToDiameter}}"
                                             Fill="{Binding Fill}"
                                             Stroke="{Binding IsActive, Converter={StaticResource BoolToStroke}}"
                                             StrokeThickness="{Binding IsActive, Converter={StaticResource BoolToStrokeThickness}}"
                                             SnapsToDevicePixels="True"
                                             Style="{StaticResource LedEllipseStyle}"/>
                                    <Label Content="{Binding Label}" Foreground="Black" FontWeight="Bold"
                                           FontSize="12"
                                           HorizontalContentAlignment="Center" VerticalContentAlignment="Center"
                                           Width="{Binding Radius, Converter={StaticResource DoubleToDiameter}}"
                                           Height="{Binding Radius, Converter={StaticResource DoubleToDiameter}}"
                                           Padding="0"
                                           Background="Transparent"
                                           BorderThickness="0"
                                           IsHitTestVisible="False"
                                           Margin="0,0,2,8"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Canvas>
            </ScrollViewer>
        </Grid>
    </DataTemplate>
</ResourceDictionary>